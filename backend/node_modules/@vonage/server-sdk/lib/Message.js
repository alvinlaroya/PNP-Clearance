"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _Utils = _interopRequireDefault(require("./Utils"));

var _ShortCode = _interopRequireDefault(require("./ShortCode"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var querystring = require("querystring");

class Message {
  static get ERROR_MESSAGES() {
    return {
      sender: "Invalid from address",
      to: "Invalid to address",
      msg: "Invalid Text Message",
      body: "Invalid Body value in Binary Message",
      udh: "Invalid udh value in Binary Message",
      title: "Invalid title in WAP Push message",
      url: "Invalid url in WAP Push message"
    };
  }

  static get PATH() {
    return "/sms/json";
  }
  /**
   * @param {Credentials} credentials
   *    credentials to be used when interacting with the API.
   * @param {Object} options
   *    Addition SMS options.
   */


  constructor(credentials) {
    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
    this.creds = credentials;
    this.options = options;

    var _shortcode = new _ShortCode.default(this.creds, this.options);

    this.shortcodeAlert = _shortcode.shortcodeAlert.bind(_shortcode);
    this.shortcode2FA = _shortcode.shortcode2FA.bind(_shortcode);
    this.shortcodeMarketing = _shortcode.shortcodeMarketing.bind(_shortcode);
  }

  _checkToAndFrom(data) {
    if (!data.from) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.sender));
    } else if (!data.to) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.to));
    } else {
      return;
    }
  } // _sendMessageCallback


  _sendMessage(data, callback) {
    this._checkToAndFrom(data);

    this.options.logger.info("sending message from " + data.from + " to " + data.to + " with message " + data.text);
    var creds = {
      api_key: this.creds.apiKey,
      api_secret: this.creds.apiSecret
    };
    var body = Object.assign({}, creds, data);
    this.options.httpClient.request({
      host: this.options.restHost || "rest.nexmo.com",
      path: Message.PATH,
      body: JSON.stringify(body),
      headers: {
        "Content-Type": "application/json"
      }
    }, "POST", (err, apiResponse) => {
      if (!err && apiResponse.status && apiResponse.messages[0].status > 0) {
        _Utils.default.sendError(callback, new Error(apiResponse.messages[0]["error-text"]), apiResponse);
      } else {
        if (callback) callback(err, apiResponse);
      }
    });
  }
  /**
   * TODO: document
   */


  sendSms(sender, recipient, message, opts, callback) {
    if (!message) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.msg));
    } else {
      if (!callback) {
        callback = opts;
        opts = {};
      }

      opts["from"] = sender;
      opts["to"] = recipient;
      opts["text"] = message;

      this._sendMessage(opts, callback);
    }
  }
  /**
   * TODO: document
   */


  sendBinaryMessage(sender, recipient, body, udh, opts, callback) {
    if (!body) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.body));
    } else if (!udh) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.udh));
    } else {
      if (!callback) {
        callback = opts;
        opts = {};
      }

      opts["from"] = sender;
      opts["to"] = recipient;
      opts["type"] = "binary";
      opts["body"] = body;
      opts["udh"] = udh;

      this._sendMessage(opts, callback);
    }
  }
  /**
   * TODO: document
   */


  sendWapPushMessage(sender, recipient, title, url, validity, opts, callback) {
    if (!title) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.title));
    } else if (!url) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.url));
    } else {
      if (typeof validity === "function") {
        callback = validity;
        opts = {};
        validity = 86400000;
      }

      if (typeof opts === "function") {
        callback = opts;
        opts = {};
      }

      opts["from"] = sender;
      opts["to"] = recipient;
      opts["type"] = "wappush";
      opts["title"] = title;
      opts["validity"] = validity;
      opts["url"] = url;

      this._sendMessage(opts, callback);
    }
  }

  search(id, callback) {
    if (typeof id == "string") {
      return this.options.rest.get("/search/message", {
        id: id
      }, callback);
    } // Otherwise we expect an array


    return this.options.rest.get("/search/messages", {
      ids: id
    }, callback);
  }

  searchRejections(to, date, callback) {
    return this.options.rest.get("/search/rejections", {
      to,
      date
    }, callback);
  }

}

var _default = Message;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9NZXNzYWdlLmpzIl0sIm5hbWVzIjpbInF1ZXJ5c3RyaW5nIiwicmVxdWlyZSIsIk1lc3NhZ2UiLCJFUlJPUl9NRVNTQUdFUyIsInNlbmRlciIsInRvIiwibXNnIiwiYm9keSIsInVkaCIsInRpdGxlIiwidXJsIiwiUEFUSCIsImNvbnN0cnVjdG9yIiwiY3JlZGVudGlhbHMiLCJvcHRpb25zIiwiY3JlZHMiLCJfc2hvcnRjb2RlIiwiU2hvcnRDb2RlIiwic2hvcnRjb2RlQWxlcnQiLCJiaW5kIiwic2hvcnRjb2RlMkZBIiwic2hvcnRjb2RlTWFya2V0aW5nIiwiX2NoZWNrVG9BbmRGcm9tIiwiZGF0YSIsImZyb20iLCJVdGlscyIsInNlbmRFcnJvciIsImNhbGxiYWNrIiwiRXJyb3IiLCJfc2VuZE1lc3NhZ2UiLCJsb2dnZXIiLCJpbmZvIiwidGV4dCIsImFwaV9rZXkiLCJhcGlLZXkiLCJhcGlfc2VjcmV0IiwiYXBpU2VjcmV0IiwiT2JqZWN0IiwiYXNzaWduIiwiaHR0cENsaWVudCIsInJlcXVlc3QiLCJob3N0IiwicmVzdEhvc3QiLCJwYXRoIiwiSlNPTiIsInN0cmluZ2lmeSIsImhlYWRlcnMiLCJlcnIiLCJhcGlSZXNwb25zZSIsInN0YXR1cyIsIm1lc3NhZ2VzIiwic2VuZFNtcyIsInJlY2lwaWVudCIsIm1lc3NhZ2UiLCJvcHRzIiwic2VuZEJpbmFyeU1lc3NhZ2UiLCJzZW5kV2FwUHVzaE1lc3NhZ2UiLCJ2YWxpZGl0eSIsInNlYXJjaCIsImlkIiwicmVzdCIsImdldCIsImlkcyIsInNlYXJjaFJlamVjdGlvbnMiLCJkYXRlIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztBQUVBOztBQUVBOzs7O0FBRUEsSUFBSUEsV0FBVyxHQUFHQyxPQUFPLENBQUMsYUFBRCxDQUF6Qjs7QUFFQSxNQUFNQyxPQUFOLENBQWM7QUFDYSxhQUFkQyxjQUFjLEdBQUc7QUFDMUIsV0FBTztBQUNMQyxNQUFBQSxNQUFNLEVBQUUsc0JBREg7QUFFTEMsTUFB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QUFrQkMsR0FBbEIsQ0FDTCxrQkFESyxFQUVMO0FBQ0VDLE1BQUFBLEdBQUcsRUFBRUg7QUFEUCxLQUZLLEVBS0xoQyxRQUxLLENBQVA7QUFPRDs7QUFFRG9DLEVBQUFBLGdCQUFnQixDQUFDMUQsRUFBRCxFQUFLMkQsSUFBTCxFQUFXckMsUUFBWCxFQUFxQjtBQUNuQyxXQUFPLEtBQUtiLE9BQUwsQ0FBYThDLElBQWIsQ0FBa0JDLEdBQWxCLENBQ0wsb0JBREssRUFFTDtBQUNFeEQsTUFBQUEsRUFERjtBQUVFMkQsTUFBQUE7QUFGRixLQUZLLEVBTUxyQyxRQU5LLENBQVA7QUFRRDs7QUF4TFc7O2VBMkxDekIsTyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5pbXBvcnQgVXRpbHMgZnJvbSBcIi4vVXRpbHNcIjtcblxuaW1wb3J0IFNob3J0Q29kZSBmcm9tIFwiLi9TaG9ydENvZGVcIjtcblxudmFyIHF1ZXJ5c3RyaW5nID0gcmVxdWlyZShcInF1ZXJ5c3RyaW5nXCIpO1xuXG5jbGFzcyBNZXNzYWdlIHtcbiAgc3RhdGljIGdldCBFUlJPUl9NRVNTQUdFUygpIHtcbiAgICByZXR1cm4ge1xuICAgICAgc2VuZGVyOiBcIkludmFsaWQgZnJvbSBhZGRyZXNzXCIsXG4gICAgICB0bzogXCJJbnZhbGlkIHRvIGFkZHJlc3NcIixcbiAgICAgIG1zZzogXCJJbnZhbGlkIFRleHQgTWVzc2FnZVwiLFxuICAgICAgYm9keTogXCJJbnZhbGlkIEJvZHkgdmFsdWUgaW4gQmluYXJ5IE1lc3NhZ2VcIixcbiAgICAgIHVkaDogXCJJbnZhbGlkIHVkaCB2YWx1ZSBpbiBCaW5hcnkgTWVzc2FnZVwiLFxuICAgICAgdGl0bGU6IFwiSW52YWxpZCB0aXRsZSBpbiBXQVAgUHVzaCBtZXNzYWdlXCIsXG4gICAgICB1cmw6IFwiSW52YWxpZCB1cmwgaW4gV0FQIFB1c2ggbWVzc2FnZVwiLFxuICAgIH07XG4gIH1cblxuICBzdGF0aWMgZ2V0IFBBVEgoKSB7XG4gICAgcmV0dXJuIFwiL3Ntcy9qc29uXCI7XG4gIH1cblxuICAvKipcbiAgICogQHBhcmFtIHtDcmVkZW50aWFsc30gY3JlZGVudGlhbHNcbiAgICogICAgY3JlZGVudGlhbHMgdG8gYmUgdXNlZCB3aGVuIGludGVyYWN0aW5nIHdpdGggdGhlIEFQSS5cbiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnNcbiAgICogICAgQWRkaXRpb24gU01TIG9wdGlvbnMuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihjcmVkZW50aWFscywgb3B0aW9ucyA9IHt9KSB7XG4gICAgdGhpcy5jcmVkcyA9IGNyZWRlbnRpYWxzO1xuICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG5cbiAgICB2YXIgX3Nob3J0Y29kZSA9IG5ldyBTaG9ydENvZGUodGhpcy5jcmVkcywgdGhpcy5vcHRpb25zKTtcblxuICAgIHRoaXMuc2hvcnRjb2RlQWxlcnQgPSBfc2hvcnRjb2RlLnNob3J0Y29kZUFsZXJ0LmJpbmQoX3Nob3J0Y29kZSk7XG4gICAgdGhpcy5zaG9ydGNvZGUyRkEgPSBfc2hvcnRjb2RlLnNob3J0Y29kZTJGQS5iaW5kKF9zaG9ydGNvZGUpO1xuICAgIHRoaXMuc2hvcnRjb2RlTWFya2V0aW5nID0gX3Nob3J0Y29kZS5zaG9ydGNvZGVNYXJrZXRpbmcuYmluZChfc2hvcnRjb2RlKTtcbiAgfVxuXG4gIF9jaGVja1RvQW5kRnJvbShkYXRhKSB7XG4gICAgaWYgKCFkYXRhLmZyb20pIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKE1lc3NhZ2UuRVJST1JfTUVTU0FHRVMuc2VuZGVyKSk7XG4gICAgfSBlbHNlIGlmICghZGF0YS50bykge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoTWVzc2FnZS5FUlJPUl9NRVNTQUdFUy50bykpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICB9XG5cbiAgLy8gX3NlbmRNZXNzYWdlQ2FsbGJhY2tcblxuICBfc2VuZE1lc3NhZ2UoZGF0YSwgY2FsbGJhY2spIHtcbiAgICB0aGlzLl9jaGVja1RvQW5kRnJvbShkYXRhKTtcblxuICAgIHRoaXMub3B0aW9ucy5sb2dnZXIuaW5mbyhcbiAgICAgIFwic2VuZGluZyBtZXNzYWdlIGZyb20gXCIgK1xuICAgICAgICBkYXRhLmZyb20gK1xuICAgICAgICBcIiB0byBcIiArXG4gICAgICAgIGRhdGEudG8gK1xuICAgICAgICBcIiB3aXRoIG1lc3NhZ2UgXCIgK1xuICAgICAgICBkYXRhLnRleHRcbiAgICApO1xuXG4gICAgbGV0IGNyZWRzID0ge1xuICAgICAgYXBpX2tleTogdGhpcy5jcmVkcy5hcGlLZXksXG4gICAgICBhcGlfc2VjcmV0OiB0aGlzLmNyZWRzLmFwaVNlY3JldCxcbiAgICB9O1xuXG4gICAgbGV0IGJvZHkgPSBPYmplY3QuYXNzaWduKHt9LCBjcmVkcywgZGF0YSk7XG4gICAgdGhpcy5vcHRpb25zLmh0dHBDbGllbnQucmVxdWVzdChcbiAgICAgIHtcbiAgICAgICAgaG9zdDogdGhpcy5vcHRpb25zLnJlc3RIb3N0IHx8IFwicmVzdC5uZXhtby5jb21cIixcbiAgICAgICAgcGF0aDogTWVzc2FnZS5QQVRILFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShib2R5KSxcbiAgICAgICAgaGVhZGVyczogeyBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIiB9LFxuICAgICAgfSxcbiAgICAgIFwiUE9TVFwiLFxuICAgICAgKGVyciwgYXBpUmVzcG9uc2UpID0+IHtcbiAgICAgICAgaWYgKCFlcnIgJiYgYXBpUmVzcG9uc2Uuc3RhdHVzICYmIGFwaVJlc3BvbnNlLm1lc3NhZ2VzWzBdLnN0YXR1cyA+IDApIHtcbiAgICAgICAgICBVdGlscy5zZW5kRXJyb3IoXG4gICAgICAgICAgICBjYWxsYmFjayxcbiAgICAgICAgICAgIG5ldyBFcnJvcihhcGlSZXNwb25zZS5tZXNzYWdlc1swXVtcImVycm9yLXRleHRcIl0pLFxuICAgICAgICAgICAgYXBpUmVzcG9uc2VcbiAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2soZXJyLCBhcGlSZXNwb25zZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFRPRE86IGRvY3VtZW50XG4gICAqL1xuICBzZW5kU21zKHNlbmRlciwgcmVjaXBpZW50LCBtZXNzYWdlLCBvcHRzLCBjYWxsYmFjaykge1xuICAgIGlmICghbWVzc2FnZSkge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoTWVzc2FnZS5FUlJPUl9NRVNTQUdFUy5tc2cpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCFjYWxsYmFjaykge1xuICAgICAgICBjYWxsYmFjayA9IG9wdHM7XG4gICAgICAgIG9wdHMgPSB7fTtcbiAgICAgIH1cbiAgICAgIG9wdHNbXCJmcm9tXCJdID0gc2VuZGVyO1xuICAgICAgb3B0c1tcInRvXCJdID0gcmVjaXBpZW50O1xuICAgICAgb3B0c1tcInRleHRcIl0gPSBtZXNzYWdlO1xuICAgICAgdGhpcy5fc2VuZE1lc3NhZ2Uob3B0cywgY2FsbGJhY2spO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOiBkb2N1bWVudFxuICAgKi9cbiAgc2VuZEJpbmFyeU1lc3NhZ2Uoc2VuZGVyLCByZWNpcGllbnQsIGJvZHksIHVkaCwgb3B0cywgY2FsbGJhY2spIHtcbiAgICBpZiAoIWJvZHkpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKE1lc3NhZ2UuRVJST1JfTUVTU0FHRVMuYm9keSkpO1xuICAgIH0gZWxzZSBpZiAoIXVkaCkge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoTWVzc2FnZS5FUlJPUl9NRVNTQUdFUy51ZGgpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCFjYWxsYmFjaykge1xuICAgICAgICBjYWxsYmFjayA9IG9wdHM7XG4gICAgICAgIG9wdHMgPSB7fTtcbiAgICAgIH1cbiAgICAgIG9wdHNbXCJmcm9tXCJdID0gc2VuZGVyO1xuICAgICAgb3B0c1tcInRvXCJdID0gcmVjaXBpZW50O1xuICAgICAgb3B0c1tcInR5cGVcIl0gPSBcImJpbmFyeVwiO1xuICAgICAgb3B0c1tcImJvZHlcIl0gPSBib2R5O1xuICAgICAgb3B0c1tcInVkaFwiXSA9IHVkaDtcbiAgICAgIHRoaXMuX3NlbmRNZXNzYWdlKG9wdHMsIGNhbGxiYWNrKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVE9ETzogZG9jdW1lbnRcbiAgICovXG4gIHNlbmRXYXBQdXNoTWVzc2FnZShzZW5kZXIsIHJlY2lwaWVudCwgdGl0bGUsIHVybCwgdmFsaWRpdHksIG9wdHMsIGNhbGxiYWNrKSB7XG4gICAgaWYgKCF0aXRsZSkge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoTWVzc2FnZS5FUlJPUl9NRVNTQUdFUy50aXRsZSkpO1xuICAgIH0gZWxzZSBpZiAoIXVybCkge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoTWVzc2FnZS5FUlJPUl9NRVNTQUdFUy51cmwpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHR5cGVvZiB2YWxpZGl0eSA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgIGNhbGxiYWNrID0gdmFsaWRpdHk7XG4gICAgICAgIG9wdHMgPSB7fTtcbiAgICAgICAgdmFsaWRpdHkgPSA4NjQwMDAwMDtcbiAgICAgIH1cbiAgICAgIGlmICh0eXBlb2Ygb3B0cyA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgIGNhbGxiYWNrID0gb3B0cztcbiAgICAgICAgb3B0cyA9IHt9O1xuICAgICAgfVxuICAgICAgb3B0c1tcImZyb21cIl0gPSBzZW5kZXI7XG4gICAgICBvcHRzW1widG9cIl0gPSByZWNpcGllbnQ7XG4gICAgICBvcHRzW1widHlwZVwiXSA9IFwid2FwcHVzaFwiO1xuICAgICAgb3B0c1tcInRpdGxlXCJdID0gdGl0bGU7XG4gICAgICBvcHRzW1widmFsaWRpdHlcIl0gPSB2YWxpZGl0eTtcbiAgICAgIG9wdHNbXCJ1cmxcIl0gPSB1cmw7XG4gICAgICB0aGlzLl9zZW5kTWVzc2FnZShvcHRzLCBjYWxsYmFjayk7XG4gICAgfVxuICB9XG5cbiAgc2VhcmNoKGlkLCBjYWxsYmFjaykge1xuICAgIGlmICh0eXBlb2YgaWQgPT0gXCJzdHJpbmdcIikge1xuICAgICAgcmV0dXJuIHRoaXMub3B0aW9ucy5yZXN0LmdldChcbiAgICAgICAgXCIvc2VhcmNoL21lc3NhZ2VcIixcbiAgICAgICAge1xuICAgICAgICAgIGlkOiBpZCxcbiAgICAgICAgfSxcbiAgICAgICAgY2FsbGJhY2tcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gT3RoZXJ3aXNlIHdlIGV4cGVjdCBhbiBhcnJheVxuICAgIHJldHVybiB0aGlzLm9wdGlvbnMucmVzdC5nZXQoXG4gICAgICBcIi9zZWFyY2gvbWVzc2FnZXNcIixcbiAgICAgIHtcbiAgICAgICAgaWRzOiBpZCxcbiAgICAgIH0sXG4gICAgICBjYWxsYmFja1xuICAgICk7XG4gIH1cblxuICBzZWFyY2hSZWplY3Rpb25zKHRvLCBkYXRlLCBjYWxsYmFjaykge1xuICAgIHJldHVybiB0aGlzLm9wdGlvbnMucmVzdC5nZXQoXG4gICAgICBcIi9zZWFyY2gvcmVqZWN0aW9uc1wiLFxuICAgICAge1xuICAgICAgICB0byxcbiAgICAgICAgZGF0ZSxcbiAgICAgIH0sXG4gICAgICBjYWxsYmFja1xuICAgICk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgTWVzc2FnZTtcbiJdfQ==