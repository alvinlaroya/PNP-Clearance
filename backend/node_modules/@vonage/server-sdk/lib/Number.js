"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _Pricing = _interopRequireDefault(require("./Pricing"));

var _Utils = _interopRequireDefault(require("./Utils"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Number {
  static get PATH() {
    return "/number";
  }

  static get ERROR_MESSAGES() {
    return {
      optionsNotAnObject: "Options parameter should be a dictionary. Check the docs for valid properties for options",
      countrycode: "Invalid Country Code",
      msisdn: "Invalid MSISDN passed"
    };
  }
  /**
   * @param {Credentials} credentials
   *    credentials to be used when interacting with the API.
   * @param {Object} options
   *    Addition Number options.
   */


  constructor(credentials) {
    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
    this.creds = credentials;
    this.options = options;
    this._pricing = new _Pricing.default(credentials, options);
  }
  /**
   * TODO: remove with next major release
   */


  getPricing() {
    this._pricing.get.apply(this, arguments);
  }
  /**
   * TODO: remove with next major release
   */


  getPhonePricing() {
    this._pricing.getPhone.apply(this, arguments);
  }
  /**
   * TODO: document
   */


  get(options, callback) {
    if (typeof options === "function") {
      callback = options;
      options = {};
    } else if (typeof options !== "object") {
      _Utils.default.sendError(callback, new Error(Number.ERROR_MESSAGES.optionsNotAnObject));
    }

    options.api_key = options.api_key || this.creds.apiKey;
    options.api_secret = options.api_secret || this.creds.apiSecret;
    this.options.httpClient.request({
      path: _Utils.default.createPathWithQuery("/account".concat(Number.PATH, "s"), options)
    }, callback);
  }
  /**
   * TODO: document
   */


  search(countryCode, pattern, callback) {
    var params = {
      api_key: this.creds.apiKey,
      api_secret: this.creds.apiSecret
    };

    if (!countryCode || countryCode.length !== 2) {
      _Utils.default.sendError(callback, new Error(Number.ERROR_MESSAGES.countrycode));
    } else {
      params["country"] = countryCode;

      if (typeof pattern === "function") {
        callback = pattern;
      } else if (typeof pattern === "object") {
        for (var arg in pattern) {
          params[arg] = pattern[arg];
        }
      } else {
        params["pattern"] = pattern;
      }

      this.options.httpClient.request({
        path: _Utils.default.createPathWithQuery("".concat(Number.PATH, "/search"), params)
      }, callback);
    }
  }
  /**
   * TODO: document
   */


  buy(countryCode, msisdn, targetApiKey, callback) {
    if (!countryCode || countryCode.length !== 2) {
      _Utils.default.sendError(callback, new Error(Number.ERROR_MESSAGES.countrycode));
    } else if (!msisdn) {
      _Utils.default.sendError(callback, new Error(Number.ERROR_MESSAGES.msisdn));
    } else {
      var opts = {
        country: countryCode,
        msisdn,
        api_key: this.creds.apiKey,
        api_secret: this.creds.apiSecret
      };

      if (targetApiKey instanceof Function) {
        callback = targetApiKey;
      } else {
        opts.target_api_key = targetApiKey;
      }

      this.options.httpClient.request({
        path: _Utils.default.createPathWithQuery("".concat(Number.PATH, "/buy"), opts)
      }, "POST", callback);
    }
  }
  /**
   * TODO: document
   */


  cancel(countryCode, msisdn, targetApiKey, callback) {
    if (!countryCode || countryCode.length !== 2) {
      _Utils.default.sendError(callback, new Error(Number.ERROR_MESSAGES.countrycode));
    } else if (!msisdn) {
      _Utils.default.sendError(callback, new Error(Number.ERROR_MESSAGES.msisdn));
    } else {
      var opts = {
        country: countryCode,
        msisdn,
        api_key: this.creds.apiKey,
        api_secret: this.creds.apiSecret
      };

      if (targetApiKey instanceof Function) {
        callback = targetApiKey;
      } else {
        opts.target_api_key = targetApiKey;
      }

      this.options.httpClient.request({
        path: _Utils.default.createPathWithQuery("".concat(Number.PATH, "/cancel"), opts)
      }, "POST", callback);
    }
  }
  /**
   * TODO: document
   */


  update(countryCode, msisdn, params, callback) {
    if (!countryCode || countryCode.length !== 2) {
      _Utils.default.sendError(callback, new Error(Number.ERROR_MESSAGES.countrycode));
    } else if (!msisdn) {
      _Utils.default.sendError(callback, new Error(Number.ERROR_MESSAGES.msisdn));
    } else {
      params["country"] = countryCode;
      params["msisdn"] = msisdn;
      params["api_key"] = this.creds.apiKey;
      params["api_secret"] = this.creds.apiSecret;
      this.options.httpClient.request({
        path: _Utils.default.createPathWithQuery("".concat(Number.PATH, "/update"), params)
      }, "POST", callback);
    }
  }

}

var _default = Number;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9OdW1iZXIuanMiXSwibmFtZXMiOlsiTnVtYmVyIiwiUEFUSCIsIkVSUk9SX01FU1NBR0VTIiwib3B0aW9uc05vdEFuT2JqZWN0IiwiY291bnRyeWNvZGUiLCJtc2lzZG4iLCJjb25zdHJ1Y3RvciIsImNyZWRlbnRpYWxzIiwib3B0aW9ucyIsImNyZWRzIiwiX3ByaWNpbmciLCJQcmljaW5nIiwiZ2V0UHJpY2luZyIsImdldCIsImFwcGx5IiwiYXJndW1lbnRzIiwiZ2V0UGhvbmVQcmljaW5nIiwiZ2V0UGhvbmUiLCJjYWxsYmFjayIsIlV0aWxzIiwic2VuZEVycm9yIiwiRXJyb3IiLCJhcGlfa2V5IiwiYXBpS2V5IiwiYXBpX3NlY3JldCIsImFwaVNlY3JldCIsImh0dHBDbGllbnQiLCJyZXF1ZXN0IiwicGF0aCIsImNyZWF0ZVBhdGhXaXRoUXVlcnkiLCJzZWFyY2giLCJjb3VudHJ5Q29kZSIsInBhdHRlcm4iLCJwYXJhbXMiLCJsZW5ndGgiLCJhcmciLCJidXkiLCJ0YXJnZXRBcGlLZXkiLCJvcHRzIiwiY291bnRyeSIsIkZ1bmN0aW9uIiwidGFyZ2V0X2FwaV9rZXkiLCJjYW5jZWwiLCJ1cGRhdGUiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7O0FBRUE7O0FBRUE7Ozs7QUFFQSxNQUFNQSxNQUFOLENBQWE7QUFDSSxhQUFKQyxJQUFJLEdBQUc7QUFDaEIsV0FBTyxTQUFQO0FBQ0Q7O0FBRXdCLGFBQWRDLGNBQWMsR0FBRztBQUMxQixXQUFPO0FBQ0xDLE1BQUFBLGtCQUFrQixFQUNoQiwyRkFGRztBQUdMQyxNQUFBQSxXQUFXLEVBQUUsc0JBSFI7QUFJTEMsTUFBQUEsTUFBTSxFQUFFO0FBSkgsS0FBUDtBQU1EO0FBQ0Q7QUFDRjtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUFDRUMsRUFBQUEsV0FBVyxDQUFDQyxXQUFELEVBQTRCO0FBQUEsUUFBZEMsT0FBYyx1RUFBSixFQUFJO0FBQ3JDLFNBQUtDLEtBQUwsR0FBYUYsV0FBYjtBQUNBLFNB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QyxFQUE4QztBQUM1Q2YscUJBQU1DLFNBQU4sQ0FBZ0JGLFFBQWhCLEVBQTBCLElBQUlHLEtBQUosQ0FBVXJCLE1BQU0sQ0FBQ0UsY0FBUCxDQUFzQkUsV0FBaEMsQ0FBMUI7QUFDRCxLQUZELE1BRU8sSUFBSSxDQUFDQyxNQUFMLEVBQWE7QUFDbEJjLHFCQUFNQyxTQUFOLENBQWdCRixRQUFoQixFQUEwQixJQUFJRyxLQUFKLENBQVVyQixNQUFNLENBQUNFLGNBQVAsQ0FBc0JHLE1BQWhDLENBQTFCO0FBQ0QsS0FGTSxNQUVBO0FBQ0w0QixNQUFBQSxNQUFNLENBQUMsU0FBRCxDQUFOLEdBQW9CRixXQUFwQjtBQUNBRSxNQUFBQSxNQUFNLENBQUMsUUFBRCxDQUFOLEdBQW1CNUIsTUFBbkI7QUFDQTRCLE1BQUFBLE1BQU0sQ0FBQyxTQUFELENBQU4sR0FBb0IsS0FBS3hCLEtBQUwsQ0FBV2MsTUFBL0I7QUFDQVUsTUFBQUEsTUFBTSxDQUFDLFlBQUQsQ0FBTixHQUF1QixLQUFLeEIsS0FBTCxDQUFXZ0IsU0FBbEM7QUFFQSxXQUFLakIsT0FBTCxDQUFha0IsVUFBYixDQUF3QkMsT0FBeEIsQ0FDRTtBQUNFQyxRQUFBQSxJQUFJLEVBQUVULGVBQU1VLG1CQUFOLFdBQTZCN0IsTUFBTSxDQUFDQyxJQUFwQyxjQUFtRGdDLE1BQW5EO0FBRFIsT0FERixFQUlFLE1BSkYsRUFLRWYsUUFMRjtBQU9EO0FBQ0Y7O0FBckxVOztlQXdMRWxCLE0iLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuaW1wb3J0IFByaWNpbmcgZnJvbSBcIi4vUHJpY2luZ1wiO1xuXG5pbXBvcnQgVXRpbHMgZnJvbSBcIi4vVXRpbHNcIjtcblxuY2xhc3MgTnVtYmVyIHtcbiAgc3RhdGljIGdldCBQQVRIKCkge1xuICAgIHJldHVybiBcIi9udW1iZXJcIjtcbiAgfVxuXG4gIHN0YXRpYyBnZXQgRVJST1JfTUVTU0FHRVMoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG9wdGlvbnNOb3RBbk9iamVjdDpcbiAgICAgICAgXCJPcHRpb25zIHBhcmFtZXRlciBzaG91bGQgYmUgYSBkaWN0aW9uYXJ5LiBDaGVjayB0aGUgZG9jcyBmb3IgdmFsaWQgcHJvcGVydGllcyBmb3Igb3B0aW9uc1wiLFxuICAgICAgY291bnRyeWNvZGU6IFwiSW52YWxpZCBDb3VudHJ5IENvZGVcIixcbiAgICAgIG1zaXNkbjogXCJJbnZhbGlkIE1TSVNETiBwYXNzZWRcIixcbiAgICB9O1xuICB9XG4gIC8qKlxuICAgKiBAcGFyYW0ge0NyZWRlbnRpYWxzfSBjcmVkZW50aWFsc1xuICAgKiAgICBjcmVkZW50aWFscyB0byBiZSB1c2VkIHdoZW4gaW50ZXJhY3Rpbmcgd2l0aCB0aGUgQVBJLlxuICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9uc1xuICAgKiAgICBBZGRpdGlvbiBOdW1iZXIgb3B0aW9ucy5cbiAgICovXG4gIGNvbnN0cnVjdG9yKGNyZWRlbnRpYWxzLCBvcHRpb25zID0ge30pIHtcbiAgICB0aGlzLmNyZWRzID0gY3JlZGVudGlhbHM7XG4gICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucztcblxuICAgIHRoaXMuX3ByaWNpbmcgPSBuZXcgUHJpY2luZyhjcmVkZW50aWFscywgb3B0aW9ucyk7XG4gIH1cblxuICAvKipcbiAgICogVE9ETzogcmVtb3ZlIHdpdGggbmV4dCBtYWpvciByZWxlYXNlXG4gICAqL1xuICBnZXRQcmljaW5nKCkge1xuICAgIHRoaXMuX3ByaWNpbmcuZ2V0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gIH1cblxuICAvKipcbiAgICogVE9ETzogcmVtb3ZlIHdpdGggbmV4dCBtYWpvciByZWxlYXNlXG4gICAqL1xuICBnZXRQaG9uZVByaWNpbmcoKSB7XG4gICAgdGhpcy5fcHJpY2luZy5nZXRQaG9uZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFRPRE86IGRvY3VtZW50XG4gICAqL1xuICBnZXQob3B0aW9ucywgY2FsbGJhY2spIHtcbiAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgY2FsbGJhY2sgPSBvcHRpb25zO1xuICAgICAgb3B0aW9ucyA9IHt9O1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIG9wdGlvbnMgIT09IFwib2JqZWN0XCIpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihcbiAgICAgICAgY2FsbGJhY2ssXG4gICAgICAgIG5ldyBFcnJvcihOdW1iZXIuRVJST1JfTUVTU0FHRVMub3B0aW9uc05vdEFuT2JqZWN0KVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBvcHRpb25zLmFwaV9rZXkgPSBvcHRpb25zLmFwaV9rZXkgfHwgdGhpcy5jcmVkcy5hcGlLZXk7XG4gICAgb3B0aW9ucy5hcGlfc2VjcmV0ID0gb3B0aW9ucy5hcGlfc2VjcmV0IHx8IHRoaXMuY3JlZHMuYXBpU2VjcmV0O1xuXG4gICAgdGhpcy5vcHRpb25zLmh0dHBDbGllbnQucmVxdWVzdChcbiAgICAgIHtcbiAgICAgICAgcGF0aDogVXRpbHMuY3JlYXRlUGF0aFdpdGhRdWVyeShgL2FjY291bnQke051bWJlci5QQVRIfXNgLCBvcHRpb25zKSxcbiAgICAgIH0sXG4gICAgICBjYWxsYmFja1xuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogVE9ETzogZG9jdW1lbnRcbiAgICovXG4gIHNlYXJjaChjb3VudHJ5Q29kZSwgcGF0dGVybiwgY2FsbGJhY2spIHtcbiAgICBsZXQgcGFyYW1zID0ge1xuICAgICAgYXBpX2tleTogdGhpcy5jcmVkcy5hcGlLZXksXG4gICAgICBhcGlfc2VjcmV0OiB0aGlzLmNyZWRzLmFwaVNlY3JldCxcbiAgICB9O1xuICAgIGlmICghY291bnRyeUNvZGUgfHwgY291bnRyeUNvZGUubGVuZ3RoICE9PSAyKSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihOdW1iZXIuRVJST1JfTUVTU0FHRVMuY291bnRyeWNvZGUpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcGFyYW1zW1wiY291bnRyeVwiXSA9IGNvdW50cnlDb2RlO1xuICAgICAgaWYgKHR5cGVvZiBwYXR0ZXJuID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgY2FsbGJhY2sgPSBwYXR0ZXJuO1xuICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcGF0dGVybiA9PT0gXCJvYmplY3RcIikge1xuICAgICAgICBmb3IgKHZhciBhcmcgaW4gcGF0dGVybikge1xuICAgICAgICAgIHBhcmFtc1thcmddID0gcGF0dGVyblthcmddO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBwYXJhbXNbXCJwYXR0ZXJuXCJdID0gcGF0dGVybjtcbiAgICAgIH1cbiAgICAgIHRoaXMub3B0aW9ucy5odHRwQ2xpZW50LnJlcXVlc3QoXG4gICAgICAgIHtcbiAgICAgICAgICBwYXRoOiBVdGlscy5jcmVhdGVQYXRoV2l0aFF1ZXJ5KGAke051bWJlci5QQVRIfS9zZWFyY2hgLCBwYXJhbXMpLFxuICAgICAgICB9LFxuICAgICAgICBjYWxsYmFja1xuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVE9ETzogZG9jdW1lbnRcbiAgICovXG4gIGJ1eShjb3VudHJ5Q29kZSwgbXNpc2RuLCB0YXJnZXRBcGlLZXksIGNhbGxiYWNrKSB7XG4gICAgaWYgKCFjb3VudHJ5Q29kZSB8fCBjb3VudHJ5Q29kZS5sZW5ndGggIT09IDIpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKE51bWJlci5FUlJPUl9NRVNTQUdFUy5jb3VudHJ5Y29kZSkpO1xuICAgIH0gZWxzZSBpZiAoIW1zaXNkbikge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoTnVtYmVyLkVSUk9SX01FU1NBR0VTLm1zaXNkbikpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsZXQgb3B0cyA9IHtcbiAgICAgICAgY291bnRyeTogY291bnRyeUNvZGUsXG4gICAgICAgIG1zaXNkbixcbiAgICAgICAgYXBpX2tleTogdGhpcy5jcmVkcy5hcGlLZXksXG4gICAgICAgIGFwaV9zZWNyZXQ6IHRoaXMuY3JlZHMuYXBpU2VjcmV0LFxuICAgICAgfTtcblxuICAgICAgaWYgKHRhcmdldEFwaUtleSBpbnN0YW5jZW9mIEZ1bmN0aW9uKSB7XG4gICAgICAgIGNhbGxiYWNrID0gdGFyZ2V0QXBpS2V5O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb3B0cy50YXJnZXRfYXBpX2tleSA9IHRhcmdldEFwaUtleTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5vcHRpb25zLmh0dHBDbGllbnQucmVxdWVzdChcbiAgICAgICAge1xuICAgICAgICAgIHBhdGg6IFV0aWxzLmNyZWF0ZVBhdGhXaXRoUXVlcnkoYCR7TnVtYmVyLlBBVEh9L2J1eWAsIG9wdHMpLFxuICAgICAgICB9LFxuICAgICAgICBcIlBPU1RcIixcbiAgICAgICAgY2FsbGJhY2tcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRPRE86IGRvY3VtZW50XG4gICAqL1xuICBjYW5jZWwoY291bnRyeUNvZGUsIG1zaXNkbiwgdGFyZ2V0QXBpS2V5LCBjYWxsYmFjaykge1xuICAgIGlmICghY291bnRyeUNvZGUgfHwgY291bnRyeUNvZGUubGVuZ3RoICE9PSAyKSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihOdW1iZXIuRVJST1JfTUVTU0FHRVMuY291bnRyeWNvZGUpKTtcbiAgICB9IGVsc2UgaWYgKCFtc2lzZG4pIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKE51bWJlci5FUlJPUl9NRVNTQUdFUy5tc2lzZG4pKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IG9wdHMgPSB7XG4gICAgICAgIGNvdW50cnk6IGNvdW50cnlDb2RlLFxuICAgICAgICBtc2lzZG4sXG4gICAgICAgIGFwaV9rZXk6IHRoaXMuY3JlZHMuYXBpS2V5LFxuICAgICAgICBhcGlfc2VjcmV0OiB0aGlzLmNyZWRzLmFwaVNlY3JldCxcbiAgICAgIH07XG5cbiAgICAgIGlmICh0YXJnZXRBcGlLZXkgaW5zdGFuY2VvZiBGdW5jdGlvbikge1xuICAgICAgICBjYWxsYmFjayA9IHRhcmdldEFwaUtleTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG9wdHMudGFyZ2V0X2FwaV9rZXkgPSB0YXJnZXRBcGlLZXk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMub3B0aW9ucy5odHRwQ2xpZW50LnJlcXVlc3QoXG4gICAgICAgIHtcbiAgICAgICAgICBwYXRoOiBVdGlscy5jcmVhdGVQYXRoV2l0aFF1ZXJ5KGAke051bWJlci5QQVRIfS9jYW5jZWxgLCBvcHRzKSxcbiAgICAgICAgfSxcbiAgICAgICAgXCJQT1NUXCIsXG4gICAgICAgIGNhbGxiYWNrXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOiBkb2N1bWVudFxuICAgKi9cbiAgdXBkYXRlKGNvdW50cnlDb2RlLCBtc2lzZG4sIHBhcmFtcywgY2FsbGJhY2spIHtcbiAgICBpZiAoIWNvdW50cnlDb2RlIHx8IGNvdW50cnlDb2RlLmxlbmd0aCAhPT0gMikge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoTnVtYmVyLkVSUk9SX01FU1NBR0VTLmNvdW50cnljb2RlKSk7XG4gICAgfSBlbHNlIGlmICghbXNpc2RuKSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihOdW1iZXIuRVJST1JfTUVTU0FHRVMubXNpc2RuKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHBhcmFtc1tcImNvdW50cnlcIl0gPSBjb3VudHJ5Q29kZTtcbiAgICAgIHBhcmFtc1tcIm1zaXNkblwiXSA9IG1zaXNkbjtcbiAgICAgIHBhcmFtc1tcImFwaV9rZXlcIl0gPSB0aGlzLmNyZWRzLmFwaUtleTtcbiAgICAgIHBhcmFtc1tcImFwaV9zZWNyZXRcIl0gPSB0aGlzLmNyZWRzLmFwaVNlY3JldDtcblxuICAgICAgdGhpcy5vcHRpb25zLmh0dHBDbGllbnQucmVxdWVzdChcbiAgICAgICAge1xuICAgICAgICAgIHBhdGg6IFV0aWxzLmNyZWF0ZVBhdGhXaXRoUXVlcnkoYCR7TnVtYmVyLlBBVEh9L3VwZGF0ZWAsIHBhcmFtcyksXG4gICAgICAgIH0sXG4gICAgICAgIFwiUE9TVFwiLFxuICAgICAgICBjYWxsYmFja1xuICAgICAgKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgTnVtYmVyO1xuIl19